<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>My Preso</title>

  <link rel="stylesheet" href="./css/reset.css" type="text/css"/>
  <link rel="stylesheet" href="./css/showoff.css" type="text/css"/>

  <script type="text/javascript" src="./js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="./js/jquery.cycle.all.js"></script>
	<script type="text/javascript" src="./js/jquery-print.js"></script>
  <script type="text/javascript" src="./js/jquery.batchImageLoad.js"></script>

  <script type="text/javascript" src="./js/jquery.doubletap-0.1.js"></script>

  <script type="text/javascript" src="./js/fg.menu.js"></script>
  <script type="text/javascript" src="./js/showoff.js"></script>
  <script type="text/javascript" src="./js/jTypeWriter.js"> </script>
  <script type="text/javascript" src="./js/sh_main.min.js"></script>
  <script type="text/javascript" src="./js/core.js"></script>
  <script type="text/javascript" src="./js/showoffcore.js"></script>

  <link type="text/css" href="./css/fg.menu.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/theme/ui.all.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/sh_style.css" rel="stylesheet" >

  
    <link rel="stylesheet" href="file/format.css" type="text/css"/>
  
    <link rel="stylesheet" href="file/code.css" type="text/css"/>
  

  

  <script type="text/javascript">
  $(function(){
    setupPreso(false, './');
  });
  </script>
</head>

<body>


<a tabindex="0" href="#search-engines" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="navmenu"><span class="ui-icon ui-icon-triangle-1-s"></span>slides</a>
<div id="navigation" class="hidden"></div>

<div id="help">
  <table>
    <tr><td class="key">space, &rarr;</td><td>next slide</td></tr>
    <tr><td class="key">&larr;</td><td>previous slide</td></tr>
    <tr><td class="key">d</td><td>debug mode</td></tr>
    <tr><td class="key">## &lt;ret&gt;</td><td>go to slide #</td></tr>
    <tr><td class="key">c</td><td>table of contents (vi)</td></tr>
    <tr><td class="key">f</td><td>toggle footer</td></tr>
    <tr><td class="key">r</td><td>reload slides</td></tr>
    <tr><td class="key">z</td><td>toggle help (this)</td></tr>
  </table>
</div>

<div class="buttonNav">
  <input type="submit" onClick="prevStep();" value="prev"/>
  <input type="submit" onClick="nextStep();" value="next"/>
</div>

<div id="preso">loading presentation...</div>
<div id="footer">
  <span id="slideInfo"></span>
  <span id="debugInfo"></span>
  <span id="notesInfo"></span>
</div>

<div id="slides" class="offscreen" style="display:none;">
<div class="slide" data-transition="none"><div class="content" ref="one/01_slide/1">
<h1>Fighting fat models</h1>

<h2>Bogdan Gusiev</h2>

<h3>July 2011</h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/2">
<p><em>Scope</em> of this presentation:</p>

<ul>
<li>Create</li>
<li>Update</li>
<li>Delete</li>
</ul>


<p><strong>Not the scope</strong> of this presentation:</p>

<ul>
<li>Select</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/3">
<h5>Why the problem appear?</h5>

<h4>All business logic code goes to <em>model by default</em>.</h4>

<br/>


<h5>Why it should not be in controller?</h5>

<h4>Because <strong>controller is hard</strong> to test, maintain and reuse.</h4>

<br/>


<h5>Why it should not be in <strong>view</strong>?</h5>

<h4>Because your will be  <strong>doom</strong> forever.</h4></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/4">
<h2>Existing techniques</h2>

<ul>
<li>Services

<ul>
<li>Separated utility class</li>
</ul>
</li>
<li>Observers

<ul>
<li>Event listeners</li>
</ul>
</li>
<li>Traits

<ul>
<li>Modules that get included to models</li>
</ul>
</li>
</ul>


<p>The problem is to <strong>understand</strong> which one <em>fit best</em> for you.</p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/5">
<h2>What do we expect?</h2>

<ul>
<li><em>Agile</em> process</li>
<li><em>Reusability</em> of the code</li>
<li>Easy to <em>test</em></li>
<li>Make the data safe <strong>strict</strong></li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/6">
<h3>The need of Services</h3>

<p>When amount of utils that supports Model goes higher support model with service is good idea.</p>

<pre class="sh_ruby"><code>
# move
User.create_from_facebook
# to
UserService.create_from_facebook
# or
FacebookService.create_user</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/7">
<h2>Services</h2>

<p>The most common way to extract logic from model is create a service.</p>

<p>Service is separated utility class.</p>

<pre class="sh_ruby"><code>module CommentService
  def create(attributes)
    comment = Comment.create!(attributes)
    deliver_notification(comment)
  end
end</code></pre>

<h4>"&#x42F; &#x437;&#x43D;&#x430;&#x44E; &#x43E;&#x442;&#x43A;&#x443;&#x434;&#x430; &#x447;&#x442;&#x43E; &#x431;&#x435;&#x440;&#x435;&#x442;&#x441;&#x44F;"</h4></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/8">
<h2>Observers</h2>

<pre class="sh_ruby"><code>class CommentObserver &lt; AR::Observer
  def after_create(comment)
    send_comment_notification(comment)
  end
end</code></pre>

<p>Nothing interesting</p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/9">
<h3>Benefits of model and observer</h3>

<p>We create default behavior and our data is safe.</p>

<p>Example: Comment can not be created without notification.</p>

<pre class="sh_ruby"><code>class Comment &lt; AR::Base
  def after_create
    send_comment_notification
  end
end</code></pre>

<p>Reimplement other person's API has more wisdom than invent new one.</p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/10">
<h2><strong>Edge cases</strong> of data creation</h2>

<h3>In all cases data created in regular way</h3>

<h3>In one edge cases special rules applied</h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/11">
<h2>Services with options</h2>

<p>Plan A:</p>

<pre class="sh_ruby"><code>module CommentService
  def create(attributes, skip_notification = false)
    comment = Comment.create!(attributes)
    unless skip_comment_notification
      deliver_notification(comment)
    end
  end
end</code></pre>

<ul>
<li>Method will be a <strong>mess</strong> as number of options goes higher.</li>
<li>Don't look very functional stylish</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/12">
<h2>Service with options</h2>

<p>Plan B:</p>

<pre class="sh_ruby"><code>module CommentService
  def create_with_notification(attributes)
  def create(attributes)
end</code></pre>

<p>Maintenance problems:</p>

<ul>
<li>Hard to keep all team informed about all services in the App</li>
<li>Don't provide default behavior</li>
<li>Hard to support as number of contexts goes higher</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/13">
<h2>Observers with option</h2>

<pre class="sh_ruby"><code>
class Comment &lt; AR::Base
  attr_accessor :skip_comment_notification
end

class CommentObserver &lt; AR::Observer
  def after_create(comment)
    unless comment.skip_comment_notification
      send_comment_notification(comment)
    end
  end
end</code></pre>

<ul>
<li>Hard to access to model internals

<ul>
<li>Some observer code stays in model</li>
</ul>
</li>
<li>Have some problems with testing</li>
<li>Makes the app more fragmented</li>
<li>"Not done well in Rails"</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/14">
<h3>Support parameter in model</h3>

<p>Solved by not persisted attributes.</p>

<pre class="sh_ruby"><code>class Comment &lt; AR::Base
  attr_accessor :skip_comment_notification
  def after_create
    unless self.skip_comment_notification
      send_comment_notification
    end
  end
end</code></pre>

<p>The property of default behavior in this example:</p>

<ul>
<li>Hey model, create my comment.

<ul>
<li>Ok</li>
</ul>
</li>
<li>Hey model, why did you send the notification?

<ul>
<li>Because you didn't say you don't need it</li>
</ul>
</li>
<li>Create model without notification

<ul>
<li>Ok</li>
</ul>
</li>
</ul>


<p><code>#skip_comment_notification</code> is used only in edge cases.</p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/15">
<h2>Priorities</h2>

<h4>Model stands for <strong>should</strong></h4>

<h4>Service stands for <em>could</em></h4>

<h4>Observer stands for <em>maybe</em></h4></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/16">
<h3>The model is still <strong>fat</strong>. What to do?</h3>

<h2><em>Vertical slicing</em> with Traits</h2>

<h5>Unlike MVC which is horizontal slicing.</h5></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/17">
<h3>Vertical slicing</h3>

<p>Split model into chunks</p>

<pre class="sh_ruby"><code>class User &lt; AR::Base
  include Traits::User::Facebook
  include Traits::User::Linkedin
  include Traits::State::CanBeDisabled
end

module Facebook
  has_one :facebook_profile
  def connected_to_facebook?
  ...
end

module CanBeDisabled
  scope :disabled
  scope :enabled
  def disable!
  def disabled?
end</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/18">
<p>Traits include all staff that can be defined in model</p>

<ul>
<li>Scopes</li>
<li>Associations</li>
<li>Validation</li>
<li>Callbacks</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/19">
<h4><em>ActiveRecord</em> uses Traits</h4>

<h5>If it is <em>possible</em> for such a <strong>complicated library</strong></h5>

<h5>then it is easy for regular projects</h5></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/20">
<h3>Traits and associations</h3>

<p>Associations is a base for Traits technique.</p>

<ul>
<li><em><code>belongs_to</code></em> is a <em>core</em> of a model that usually used almost everywhere.

<ul>
<li>This associations is used in almost all methods.</li>
</ul>
</li>
<li><em><code>has_many</code></em> is usually <em>better</em> to create a slice of functionality.

<ul>
<li>Methods with this associations is usually independent from each other.</li>
</ul>
</li>
</ul>


<table>
<tr>
<td>belongs_to :company</td>
<td>belongs_to :location</td>
</tr>
<tr>
<td colspan="2">Job</td>
</tr>
<tr>
<td>has_many :candidates</td>
<td>has_many :criterias</td>
</tr>

</table>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/21">
<h3>Basic application architecture</h3>

<table>
<tr>
  <td colspan="3">View</td>
</tr>
<tr>
  <td colspan="3">Controller</td>
</tr>
<tr>
  <td colspan="3" style="padding-top: 0px; padding-bottom: 0px">Thin model</td>
</tr>

<tr>
  <td style="padding-top: 40px; padding-bottom: 40px">Trait</td>
  <td>Trait</td>
  <td>Trait</td>
</tr>

</table>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/22">
<h3>let's talk about</h3>

<h3><strong>BIG FAT ENTERPRISE</strong></h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/23">
<h3>Enterprise world</h3>

<p><em>Agile</em> projects are <em>well focused</em></p>

<p><strong>Enterprise</strong> apps use to <strong>do everything</strong>.</p>

<p>That is why:</p>

<ul>
<li>More huge web forms</li>
<li>More complicated data structure</li>
<li>More significant updates</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/24">
<h3>When services are getting fatter,</h3>

<h5>there is a need to</h5>

<h2>Extract <em>Workflow</em> from service.</h2></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/25">
<h2>Workflow designed to handle huge updates for data</h2>

<p>WorkFlow is logic layer controller, because of it's "gathering" role.</p>

<p>Parts of WorkFlow that should be <em>reused</em> are extracted to <em>services</em>.</p>

<pre class="sh_ruby"><code>module BillingWorkFlow
  def self.charge(cycle)
    cycle.close!
    cycle.items.each do |item|
      item.charge!
    end
    UserMailer.cycle_charged(cycle).deliver!
    ProjectService.close_stages(cycle.job)
    ProjectService.generate_new_cycle(cycle.job)
    .....
  end
end</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/26">
<h2>Improve safety of Workflow</h2>

<ul>
<li>Workflow method designed to have only one usage.</li>
<li>Protect state attribute from mass assignment</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/27">
<h2>Flow nature and Event nature</h2>

<p>Flow :</p>

<ul>
<li>goes step by step</li>
<li>can not be part of each other</li>
<li>more related on utils</li>
</ul>


<p>Event:</p>

<ul>
<li>less care about order</li>
<li>one can spawn more than one other events</li>
<li>can be parallelized</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/28">
<h2>Super advanced logic infrastructure</h2>

<p><img src="file:///home/bogdan/makabu/my/blog/slides/fighting_fat_models/one/architechture.png" width="789" height="458" alt="Architecture"/></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/29">
<h3>There is only one 100% reason</h3>

<h3>when this can be broken?</h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/30">
<h3>Of course this is</h3>

<h2>Perfomance</h2>

<h4>Others are doubtful</h4></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/31">
<h2>Summary</h2>

<p>Every technique has it's own use case:</p>

<ul>
<li>Service for helpers</li>
<li>Traits for strict data model</li>
<li>Observers for external service notification</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/32">
<h3>The <strong>End</strong></h3>

<h4>Thanks for <em>watching</em></h4>

<h5><a href="http://gusiev.com">http://gusiev.com</a></h5>

<h5><a href="https://github.com/bogdan">https://github.com/bogdan</a></h5></div>
</div></div>

</body>
</html>
