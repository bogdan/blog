<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Fighting with fat models - Bogdan G.</title>

  <link rel="stylesheet" href="./css/reset.css" type="text/css"/>
  <link rel="stylesheet" href="./css/showoff.css" type="text/css"/>

  <script type="text/javascript" src="./js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="./js/jquery.cycle.all.js"></script>
	<script type="text/javascript" src="./js/jquery-print.js"></script>
  <script type="text/javascript" src="./js/jquery.batchImageLoad.js"></script>

  <script type="text/javascript" src="./js/jquery.doubletap-0.1.js"></script>

  <script type="text/javascript" src="./js/fg.menu.js"></script>
  <script type="text/javascript" src="./js/showoff.js"></script>
  <script type="text/javascript" src="./js/jTypeWriter.js"> </script>
  <script type="text/javascript" src="./js/sh_main.min.js"></script>
  <script type="text/javascript" src="./js/core.js"></script>
  <script type="text/javascript" src="./js/showoffcore.js"></script>

  <link type="text/css" href="./css/fg.menu.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/theme/ui.all.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/sh_style.css" rel="stylesheet" >

  
    <link rel="stylesheet" href="file/code.css" type="text/css"/>
  
    <link rel="stylesheet" href="file/format.css" type="text/css"/>
  

  

  <script type="text/javascript">
  $(function(){
    setupPreso(false, './');
  });
  </script>
</head>

<body>


<a tabindex="0" href="#search-engines" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="navmenu"><span class="ui-icon ui-icon-triangle-1-s"></span>slides</a>
<div id="navigation" class="hidden"></div>

<div id="help">
  <table>
    <tr><td class="key">space, &rarr;</td><td>next slide</td></tr>
    <tr><td class="key">&larr;</td><td>previous slide</td></tr>
    <tr><td class="key">d</td><td>debug mode</td></tr>
    <tr><td class="key">## &lt;ret&gt;</td><td>go to slide #</td></tr>
    <tr><td class="key">c</td><td>table of contents (vi)</td></tr>
    <tr><td class="key">f</td><td>toggle footer</td></tr>
    <tr><td class="key">r</td><td>reload slides</td></tr>
    <tr><td class="key">z</td><td>toggle help (this)</td></tr>
  </table>
</div>

<div class="buttonNav">
  <input type="submit" onClick="prevStep();" value="prev"/>
  <input type="submit" onClick="nextStep();" value="next"/>
</div>

<div id="preso">loading presentation...</div>
<div id="footer">
  <span id="slideInfo"></span>
  <span id="debugInfo"></span>
  <span id="notesInfo"></span>
</div>

<div id="slides" class="offscreen" style="display:none;">
<div class="slide" data-transition="none"><div class="content" ref="one/01_slide/1">
<h1>Fighting with fat models</h1>

<h5>and many other problems</h5>

<h2>Bogdan Gusiev</h2>

<h3>September 2011</h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/2">
<h2>Bogdan G.</h2>

<ul>
<li>is 7 years in IT, 3 years with Ruby and Rails</li>
<li><p>Contributed to:</p>

<ul>
<li>Rails

<ul>
<li>wait for my features in 3.2</li>
<li>Deeply understands Rails internals</li>
<li>In context of Rails moving direction</li>
</ul>
</li>
<li>Resque and about 5-7 plugins

<ul>
<li>Knows something about high load</li>
</ul>
</li>
<li>Many others</li>
</ul>
</li>
<li><p>Created:</p>

<ul>
<li><a href="http://github.com/bogdan/datagrid">datagrid</a> - 180+ watchers</li>
<li><a href="http://github.com/railsware/js-routes">js-routes</a> - 100+ watchers</li>
</ul>
</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/3">
<h5>Why the problem appear?</h5>

<h4>All business logic code goes to <em>model by default</em>.</h4>

<br/>


<h5>Why it should not be in controller?</h5>

<h4>Because <strong>controller is hard</strong> to test, maintain and reuse.</h4>

<br/>


<h5>Why it should not be in <strong>view</strong>?</h5>

<h4>Many reasons</h4></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/4">
<h1><strong>250 Lines of code</strong></h1></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/5">
<h1><em>Update</em></h1>

<h2>but not:</h2>

<h1><strong>Select</strong></h1></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/6">
<h2>Existing techniques</h2>

<ul>
<li>Services

<ul>
<li>Separated utility class</li>
</ul>
</li>
<li>Observers

<ul>
<li>Event listeners</li>
</ul>
</li>
<li>Traits

<ul>
<li>Modules that get included to models</li>
</ul>
</li>
</ul>


<p>The problem is to <strong>understand</strong> which one <em>fit best</em> for you.</p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/7">
<h2>What do we expect?</h2>

<p>Standard:</p>

<ul>
<li><em>Agile</em></li>
<li><em>Reusable</em></li>
<li>Easy to <em>test</em></li>
</ul>


<p>Specific:</p>

<ul>
<li><em>MORE</em> FEATURES PER SECOND</li>
<li>Make the data  <strong>safe</strong></li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/8">
<h3>The need of Services</h3>

<h5>When amount of utils that supports Model goes higher</h5>

<h5>extract them to service is good idea.</h5>

<pre class="sh_ruby"><code>
# move
User.create_from_facebook
# to
UserService.create_from_facebook
# or
FacebookService.create_user</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/9">
<h2>Services</h2>

<p>The most common way to extract logic from model is create a service.</p>

<p>Service is separated utility class.</p>

<pre class="sh_ruby"><code>module CommentService
  def self.create(attributes)
    comment = Comment.create!(attributes)
    deliver_notification(comment)
  end
end</code></pre>

<h4>"&#x42F; &#x437;&#x43D;&#x430;&#x44E; &#x43E;&#x442;&#x43A;&#x443;&#x434;&#x430; &#x447;&#x442;&#x43E; &#x431;&#x435;&#x440;&#x435;&#x442;&#x441;&#x44F;"</h4></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/10">
<h4>The problem of services</h4>

<h3>Services <strong>don't</strong> provide <em>default behavior</em></h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/11">
<h2>Need of Default Behavior</h2>

<p>Object should incapsulate behavior:</p>

<ul>
<li>Data Validation

<ul>
<li>Set of rules that model should fit at programming level

<ul>
<li>Comment should have author</li>
</ul>
</li>
</ul>
</li>
<li>Business rules

<ul>
<li>Set of rules that model should fit to exist in real world

<ul>
<li>Comment should deliver email notification</li>
</ul>
</li>
</ul>
</li>
</ul>


<p>(Circles here)</p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/12">
<h4>What is a model?</h4>

<h3>The model is an imitation of real object</h3>

<h3>that reflects some it's behaviors</h3>

<h3>that we are focused on.</h3>

<h5>Wikipedia</h5></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/13">
<h2>Implementation</h2>

<p>Using builtin Rails code:</p>

<ul>
<li>ActiveModel::Observer</li>
<li>ActiveRecord::Callbacks</li>
</ul>


<p>Have the following benefits:</p>

<ul>
<li>Reduce number of conventions</li>
<li>Suites to common knowledge - nothing more than Rails</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/14">
<h2>Hooks in models</h2>

<p>We create default behavior and our data is safe.</p>

<p>Example: Comment can not be created without notification.</p>

<pre class="sh_ruby"><code>class Comment &lt; AR::Base
  after_create :send_comment_notification
end</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/15">
<h2>Observers</h2>

<p>Model sends it's events to observer automatically and observer is calling a hook.</p>

<pre class="sh_ruby"><code>class CommentObserver &lt; AR::Observer
  def after_create(comment)
    send_comment_notification(comment)
  end
end</code></pre>

<ul>
<li><em>+</em> Model doesn't depend on the notification code</li>
<li><strong>-</strong> Some folks say: "Observers Not done well in Rails"</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/16">
<h2>API comparision</h2>

<pre class="sh_ruby"><code>Comment.create
# or
CommentService.create</code></pre>

<h4>Reimplement other person's API</h4>

<h4>has more wisdom than invent new one.</h4></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/17">
<h2><strong>Edge cases</strong></h2>

<h3>In all cases data created in regular way</h3>

<h3>In one edge cases special rules applied</h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/18">
<h2>Service with options</h2>

<p>Plan A:</p>

<pre class="sh_ruby"><code>module CommentService
  def self.create_with_notification(attributes)
  def self.create(attributes)
end</code></pre>

<p>Maintenance problems:</p>

<ul>
<li>Hard to keep all team informed about all services in the App</li>
<li>Hard to support as number of options goes higher</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/19">
<h2>Services with options</h2>

<p>Plan B:</p>

<pre class="sh_ruby"><code>module CommentService
  def self.create(attributes, skip_notification = false)
end</code></pre>

<ul>
<li>Method will be a <strong>mess</strong> as number of options goes higher.</li>
<li>Don't respect functional paradigm

<ul>
<li>As many functions as possible</li>
</ul>
</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/20">
<h2><em>Default behavior</em> and <strong>edge cases</strong></h2>

<p>The property of default behavior in this example:</p>

<ul>
<li>Hey model, create my comment.

<ul>
<li>Ok</li>
</ul>
</li>
<li>Hey model, why did you send the notification?

<ul>
<li>Because you didn't say you don't need it</li>
</ul>
</li>
<li>Hey model, create model without notification

<ul>
<li>Ok</li>
</ul>
</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/21">
<h2>Observers with option</h2>

<pre class="sh_ruby"><code>
class Comment &lt; AR::Base
  attr_accessor :skip_comment_notification
end

class CommentObserver &lt; AR::Observer
  def after_create(comment)
    deliver_notification(comment) \
      unless comment.skip_comment_notification
  end
end</code></pre>

<ul>
<li>Hard to access to model internals

<ul>
<li>Some observer code stays in model</li>
</ul>
</li>
<li>Have some problems with testing</li>
<li>Makes feature code more fragmented</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/22">
<h3>Support parameter in model</h3>

<pre class="sh_ruby"><code>class Comment &lt; AR::Base
  attr_accessor :skip_comment_notification
  after_create do
    send_comment_notification \
      unless self.skip_comment_notification
  end
end</code></pre>

<p><code>#skip_comment_notification</code> is used only in edge cases.</p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/23">
<h3>Observers are effective when</h3>

<h2><strong>no direct access</strong> to <em>observed class</em></h2>

<h4>Example: when it is part of some library inside</h4>

<h4>a fat enterprise project</h4></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/24">
<h2>Observer &lt;=&gt; Trait</h2>

<h3>conversion is <em>cheap</em></h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/25">
<h3>Model stands for <em>should</em></h3>

<h3>Service stands for <em>could</em></h3>

<h3>Observer stands for <strong>big fat enterprise</strong></h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/26">
<h2>The model is still <strong>fat</strong>.</h2>

<h2>What to do?</h2></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/27">
<h2>Use traits</h2>

<pre class="sh_ruby"><code>class Comment &lt; AR::Base
  include Traits::Comment::Notification
end</code></pre>

<p><code>Notification</code> module encapsulates a feature</p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/28">
<h3><em>Vertical slicing</em> stands for</h3>

<h2>Split things by features</h2>

<h2>but not by objects</h2>

<h4><strong>Unlike MVC</strong> which is horizontal slicing.</h4></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/29">
<h3>Vertical slicing</h3>

<p>Split model into <em>Traits</em></p>

<pre class="sh_ruby"><code>class User &lt; AR::Base
  include Traits::User::Facebook
  include Traits::User::Linkedin
  include Traits::State::CanBeDisabled
end

module Facebook
  has_one :facebook_profile
  def connected_to_facebook?
  ...
end

module CanBeDisabled
  scope :disabled
  scope :enabled
  def disable!
  def disabled?
end</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/30">
<h3>Basic application architecture</h3>

<table>
<tr>
  <td colspan="3">View</td>
</tr>
<tr>
  <td colspan="3">Controller</td>
</tr>
<tr>
  <td colspan="3" style="padding-top: 0px; padding-bottom: 0px">Thin model</td>
</tr>

<tr>
  <td style="padding-top: 40px; padding-bottom: 40px">Trait</td>
  <td>Trait</td>
  <td>Trait</td>
</tr>

</table>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/31">
<h2>This is OOP</h2>

<h3>Traits include all staff that can be defined in model</h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/32">
<h3>Dependencies appear</h3>

<p>As number of traits grow:</p>

<ul>
<li>associations</li>
<li>attributes</li>
</ul>


<h4>Dependency tree</h4>

<p><img src="file:///home/bogdan/makabu/my/blog/slides/fighting_fat_models/one/./file/model_dependency.png" alt="Model dependency"/></p>

<!--<table>-->


<!--<tr>-->


<!--<td colspan="4">Model</td>-->


<!--</tr>-->


<!--<tr>-->


<!--<td colspan="2">belongs_to :model1</td> -->


<!--<td colspan="2">belongs_to :model2</td>-->


<!--</tr>-->


<!--<tr>-->


<!--<td>attribute1</td>-->


<!--<td>attribute2</td>-->


<!--<td>attribute3</td>-->


<!--<td>attribute4</td>-->


<!--</tr>-->


<!--<tr>-->


<!--<td colspan="2">has_many :models3</td>-->


<!--<td colspan="2">has_many :models4</td>-->


<!--</tr>-->




<!--</table>-->
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/33">
<h2>Associations and Traits</h2>

<p>Associations is a base for Traits technique.</p>

<ul>
<li><em><code>belongs_to</code></em> is a <em>core</em> of a model

<ul>
<li>This associations is used in almost all methods.</li>
</ul>
</li>
<li><em><code>has_many</code></em> is usually <em>better</em> to create a slice

<ul>
<li>Methods with this associations is usually independent from each other.</li>
</ul>
</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/34">
<h4>How to not get lost?</h4>

<h2>If <em>A</em> depends on <em>B</em></h2>

<h2>then <strong>B</strong> should not depend on <strong>A</strong></h2></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/35">
<h2>Traits best practices</h2>

<ul>
<li>Apply pattern to <em>multifunctional models</em> only

<ul>
<li><code>User</code></li>
</ul>
</li>
<li><p>Traits name space with the same name as model</p>

<ul>
<li><code>Traits::User::Facebook</code></li>
</ul>
</li>
<li><p>Use <em>OOP</em>:</p>

<ul>
<li>Abstract method</li>
<li><code>super</code> is super</li>
</ul>
</li>
<li><p>Api <em>consistency</em></p>

<ul>
<li>"name", "subject", "title" =&gt; select one</li>
<li>"disabled", "inactive", "deleted" =&gt; select one</li>
</ul>
</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/36">
<h2>Libraries using traits</h2>

<ul>
<li>ActiveRecord</li>
<li>Authlogic</li>
<li>Devise</li>
<li>Datagrid</li>
</ul>


<!--##### If it is *possible* for such a **complicated library** -->


<!--##### then it is **easy** for *regular projects*-->
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/37">
<h2><em>Flow</em> nature and <em>Event</em> nature</h2>

<p>Service has flow nature:</p>

<ul>
<li>goes step by step

<ul>
<li>order can matter</li>
</ul>
</li>
<li>call each other

<ul>
<li>dependent</li>
</ul>
</li>
</ul>


<p>Observers and Callbacks have event nature:</p>

<ul>
<li>one can spawn more than one other events

<ul>
<li>can be parallelized</li>
</ul>
</li>
<li>don't call each other

<ul>
<li>can be backgrounded</li>
</ul>
</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/38">
<h2>Super advanced logic infrastructure</h2>

<p><img src="file:///home/bogdan/makabu/my/blog/slides/fighting_fat_models/one/./file/architechture.png" alt="Architecture"/></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/39">
<h3>There is only one 100% reason</h3>

<h3>when this can be broken.</h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/40">
<h3>Of course this is</h3>

<h2>Perfomance</h2>

<h4>Others are doubtful</h4></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/41">
<h1>Summary</h1></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/42">
<h3><em>Could?</em>  =&gt; <strong>Service</strong></h3>

<h3><em>Should?</em> =&gt; <strong>Model</strong></h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/43">
<h2><strong>Fat</strong> models =&gt; <em>Thin</em> Traits</h2>

<h4>and sometimes observers</h4></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/44">
<h3><em>Reimplement</em> other person's API</h3>

<h3>has more wisdom than <strong>invent new</strong> one.</h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/45">
<h3>If <em>A</em> depends on <em>B</em></h3>

<h3>then <strong>B</strong> should not depend on <strong>A</strong></h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/46">
<h3>The <strong>End</strong></h3>

<h4>Thanks for <em>watching</em></h4>

<h5><a href="http://gusiev.com">http://gusiev.com</a></h5>

<h5><a href="https://github.com/bogdan">https://github.com/bogdan</a></h5></div>
</div></div>

</body>
</html>
