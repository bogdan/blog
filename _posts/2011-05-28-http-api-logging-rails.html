--- 
layout: post
title: Logging HTTP api calls just like database queries
published: false
tags: 
- api
- http
- logging
- ruby
- rails
---

Http api calls are pretty similar to SQL queries - they query data from external source to ruby code workspace. So I think it's a good idea to log them just like ActiveRecord does with SQL queries. 
<pre><code>  Location Load (25.1ms)   SELECT * FROM "locations" WHERE ("locations"."id" = 2548) ORDER BY title</code></pre>

This simple peace of code could be very helpful in case of debugging the HTTP api:<br/>
<a href="https://gist.github.com/846102">Log external http calls in rails log</a> 
<br/>
<a href="http://img6.imagebanana.com/img/zs0jw1cc/screenshot_013.png">Screenshot</a>
<br/>
<br/>
Want to show the most interesting part:
<pre><code>  def request(request, body = nil, &amp;block)
    time = Time.now
    response = request_without_log(request, body, &amp;block)
    response
  ensure
    if self.started?
      url = "http#{"s" if self.use_ssl?}://#{self.address}:#{self.port}#{request.path}"
      ofset = Time.now - time
      rails_log("HTTP #{request.method} (%0.2fms)" % (ofset * 1000), url)
      rails_log("POST params", request.body) if request.is_a?(::Net::HTTP::Post)
      if defined?(response) &amp;&amp; response
        rails_log("Response status", "#{response.class} (#{response.code})") 
        body = response.body
        rails_log("Response body", body) unless body.is_a?(Net::ReadAdapter)
      end
    end</code></pre>
<br/>
Pay attention on how <strong>ensure</strong> works with context.
The <em>response</em> local variable defined inside of <em>def</em> and <em>ensure</em>, but still accessible in after ensure if there was no exception inside of <em>request_without_log</em>. This would never be possible in static programming language.

